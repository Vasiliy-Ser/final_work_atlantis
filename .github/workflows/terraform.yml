name: Terraform CI/CD (Yandex Cloud)

on:
  push:
    branches:
      - main
    paths:
#      - 'preliminary/**'
      - 'implementation/**'
      - '.github/workflows/terraform.yml'

# env:
#   AWS_ACCESS_KEY_ID:: ${{ secrets.YC_ACCESS_KEY_ID }}
#   AWS_SECRET_ACCESS_KEY: ${{ secrets.YC_SECRET_ACCESS_KEY }}
#   TF_VAR_kms_key_id: ${{ secrets.YC_KMS_KEY_ID }}
#   TF_VAR_bucket_name: ${{ secrets.YC_BUCKET_NAME }}
#   TF_VAR_cloud_id: ${{ secrets.CLOUD_ID }}
#   TF_VAR_folder_id: ${{ secrets.FOLDER_ID }}
#   TF_VAR_region: "ru-central1"
#   YC_KEY_JSON: ${{ secrets.YC_KEY_JSON }}
#   YC_SERVICE_ACCOUNT_KEY_FILE: ${{ github.workspace }}/key.json



jobs:
  # terraform-preliminary:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4

  #     - name: Setup Terraform
  #       uses: hashicorp/setup-terraform@v2
  #       with:
  #         terraform_version: 1.7.0

  #     - name: Setup Python for YC CLI
  #       uses: actions/setup-python@v4
  #       with:
  #         python-version: '3.x'

  #     - name: Install YC CLI
  #       run: pip install yandexcloud

  #     - name: Write YC key file
  #       run: echo '${{ secrets.YC_KEY_JSON }}' > $YC_SERVICE_ACCOUNT_KEY_FILE
      
  #     - name: Debug working directory
  #       run: |
  #         echo "Current directory: $(pwd)"
  #         ls -la

  #     - name: Terraform Init
  #       run: terraform init
  #       working-directory: preliminary

  #     - name: Terraform Validate
  #       run: terraform validate
  #       working-directory: preliminary

  #     - name: Terraform Plan
  #       working-directory: preliminary
  #       env:
  #         TF_VAR_service_account_key_file: ${{ env.YC_SERVICE_ACCOUNT_KEY_FILE }}
  #         TF_VAR_cloud_id: ${{ secrets.CLOUD_ID }}
  #         TF_VAR_folder_id: ${{ secrets.FOLDER_ID }}
  #       run: terraform plan -out=tfplan

  #     - name: Terraform Apply
  #       if: github.ref == 'refs/heads/main'
  #       working-directory: preliminary
  #       env:
  #         TF_VAR_service_account_key_file: ${{ env.YC_SERVICE_ACCOUNT_KEY_FILE }}
  #         TF_VAR_cloud_id: ${{ secrets.CLOUD_ID }}
  #         TF_VAR_folder_id: ${{ secrets.FOLDER_ID }}
  #       run: terraform apply -auto-approve tfplan

  terraform-implementation:
    runs-on: ubuntu-latest
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.YC_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.YC_SECRET_ACCESS_KEY }}
      TF_VAR_kms_key_id: ${{ secrets.YC_KMS_KEY_ID }}
      TF_VAR_bucket_name: ${{ secrets.YC_BUCKET_NAME }}
      TF_VAR_cloud_id: ${{ secrets.CLOUD_ID }}
      TF_VAR_folder_id: ${{ secrets.FOLDER_ID }}
      TF_VAR_service_account_key_file: ${{ github.workspace }}/key.json
      YC_KEY_JSON: ${{ secrets.YC_KEY_JSON }}
      YC_SERVICE_ACCOUNT_KEY_FILE: ${{ github.workspace }}/key.json

  #  needs: terraform-preliminary
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.8.4

      - name: Setup Python for YC CLI
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install YC CLI
        run: pip install yandexcloud

      - name: Write YC key file
        run: echo '${{ secrets.YC_KEY_JSON }}' > $YC_SERVICE_ACCOUNT_KEY_FILE

      - name: Terraform Init
        run: terraform init
        working-directory: implementation

      - name: Terraform State List
        run: terraform state list || echo "⚠️ No state found or backend empty"
        working-directory: implementation

      - name: Terraform Validate
        run: terraform validate
        working-directory: implementation

      - name: Prevent Destructive Changes
        run: |
          if terraform show -json tfplan | jq -e '.resource_changes[] | select(.change.actions[] == "delete")' > /dev/null; then
            echo "❌ ABORTING: Destructive changes detected!"
            exit 1
          fi
        working-directory: implementation

      - name: Terraform Plan
        working-directory: implementation
        run: terraform plan -out=tfplan
      
      - name: Terraform Apply
        if: github.ref == 'refs/heads/main'
        working-directory: implementation
        run: terraform apply -auto-approve tfplan
            
